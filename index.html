<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Danh sách sản phẩm</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/styles.css?v=3" />
</head>

<body class="mode-items">

  <h1>Danh sách sản phẩm</h1>

  <!-- ===== TOP CONTROLS ===== -->
  <div class="top-controls">
    <button class="btn toggle" id="showFavsBtn" aria-pressed="false">
      Yêu thích
    </button>

    <button class="btn" id="showInvoicesBtn">
      Hoá đơn
    </button>

    <button class="btn" id="showStatisticalBtn">
      Thống kê
    </button>
  </div>

  <!-- ===== INVOICE LIST PANEL (ONLY IN INVOICE MODE) ===== -->
  <div class="invoice-list-wrapper">
    <div id="invoiceListPanel" style="max-width:100%;">
      <div style="
        background:#fff;
        border-radius:10px;
        padding:10px;
        border:1px solid #e6e9ef;
        box-shadow:0 8px 20px rgba(12,24,40,0.04);
      ">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <strong>Danh sách hoá đơn</strong>
          <div class="invoice-filters">
            <input type="date" id="filterDate" />

            <select id="filterStatus">
              <option value="all">Tất cả</option>
              <option value="1">Đơn mới</option>
              <option value="2">Đã thanh toán</option>
              <option value="3">Đã huỷ</option>
            </select>

            <select id="filterLimit">
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="25">25</option>
              <option value="30">30</option>
            </select>
          </div>

          <div class="invoice-pagination">
            <button class="btn" id="prevPageBtn">← Trước</button>
            <span id="pageInfo" class="muted">Trang 1</span>
            <button class="btn" id="nextPageBtn">Sau →</button>
          </div>

          <button class="btn" id="refreshInvoicesBtn" style="padding:6px 10px;">
            Tải lại
          </button>
        </div>

        <div id="invoiceList" style="overflow:auto;">
          <!-- renderInvoiceList() -->
        </div>

        <div id="invoiceListEmpty" class="muted hidden" style="padding-top:8px;">
          Chưa có hoá đơn nào.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PRODUCT LIST ===== -->
  <div class="list" id="product-list" aria-live="polite">
    <!-- render products -->
  </div>

  <!-- ===== BOTTOM CONTROLS ===== -->
  <div class="bottom-controls">
    <div class="control">
      <label class="muted">
        Phí ship
        <input id="ship_fee" type="text" value="0" data-raw="0" inputmode="numeric" />
      </label>
    </div>

    <div class="control">
      <label class="muted">
        Giảm giá
        <input id="discount" type="text" value="0" data-raw="0" inputmode="numeric" />
      </label>
    </div>

    <div class="actions" style="margin-left:auto;">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="collapseBtn">Hoá đơn</button>
    </div>
  </div>

  <!-- ===== SUMMARY ===== -->
  <div class="summary">
    <div class="muted">
      Món đã chọn: <span id="selectedCount">0</span>
      · Yêu thích: <span id="favCount">0</span>
    </div>
    <div class="total">
      Tổng: <span id="grandTotal">0</span> ₫
    </div>
  </div>

  <!-- ===== MODAL INVOICE ===== -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="document">

      <h2>Hoá đơn</h2>

      <div id="compactList" class="compact"></div>

      <div class="footer">
        <div class="meta-lines">
          <div>Phí ship: <span id="modal_ship">0đ</span></div>
          <div>Giảm giá: <span id="modal_discount">0đ</span></div>
        </div>
        <div class="total-line">
          Tổng: <span id="modal_total">0đ</span>
        </div>
      </div>

      <!-- PAYMENT -->
      <div class="payment-row">
        <div class="small-muted">
          <label>
            <input type="radio" name="payment_method" value="cash" checked />
            Tiền mặt
          </label>
          <label style="margin-left:10px;">
            <input type="radio" name="payment_method" value="qr" />
            QR
          </label>
        </div>

        <div class="cash-box" id="cashContainer">
          <label class="small-muted">
            Tiền khách đưa:
            <input id="cash_given" type="text" value="0" data-raw="0" inputmode="numeric"
                   style="padding:6px; border-radius:6px; border:1px solid #ddd; min-width:120px;" />
          </label>
          <div class="small-muted">
            Trả lại: <strong id="change_due">0đ</strong>
          </div>
        </div>
      </div>

      <!-- QR -->
      <div id="qrContainer" class="qr-box hidden"></div>
      <div id="qrError" class="error hidden"></div>

      <!-- ACTIONS -->
      <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
        <label class="small-muted">
          Tên đơn:
          <input id="order_name" type="text" placeholder="Mặc định: H:i d-m-y"
                 style="padding:6px; border-radius:6px; border:1px solid #ddd; min-width:180px;" />
        </label>

        <div class="note-block">
          <label class="muted">Ghi chú hoá đơn</label>
          <textarea
            id="invoice_note"
            rows="3"
            placeholder="Ví dụ: khách quen, ship sau 30p..."
          ></textarea>
        </div>

        <button class="btn" id="saveInvoiceBtn">Lưu hoá đơn</button>
        <button class="btn" id="closeModal">Đóng</button>
      </div>

    </div>
  </div>

  <!-- ===== MODAL STATISTICAL ===== -->
  <div class="modal-backdrop hidden" id="statBackdrop" aria-hidden="true">
    <div class="modal" id="statModal" role="dialog" aria-modal="true" aria-labelledby="statTitle">

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h2 id="statTitle" style="margin:0;">Thống kê</h2>
        <button class="btn" id="closeStatModal" type="button" aria-label="Đóng thống kê">Đóng</button>
      </div>

      <!-- Filters -->
      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
        <div>
          <label class="muted" style="display:block; margin-bottom:4px;">Từ ngày</label>
          <input type="date" id="statFromDate" />
        </div>

        <div>
          <label class="muted" style="display:block; margin-bottom:4px;">Đến ngày</label>
          <input type="date" id="statToDate" />
        </div>

        <div>
          <label class="muted" style="display:block; margin-bottom:4px;">Trạng thái</label>
          <!-- mặc định chỉ lấy "Đã thanh toán" -->
          <select id="statStatus">
            <option value="2" selected>Đã thanh toán</option>
            <option value="all">Tất cả</option>
            <option value="1">Đơn mới</option>
            <option value="3">Đã huỷ</option>
          </select>
        </div>

        <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="statQuickToday" type="button">Hôm nay</button>
          <button class="btn" id="statQuick7d" type="button">7 ngày</button>
          <button class="btn" id="statQuick30d" type="button">30 ngày</button>
          <button class="btn" id="statRefreshBtn" type="button">Tải thống kê</button>
        </div>
      </div>

      <!-- Summary cards -->
      <div style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
        <div style="background:#fff; border:1px solid #e6e9ef; border-radius:10px; padding:10px; box-shadow:0 8px 20px rgba(12,24,40,0.04);">
          <div class="muted">Tổng doanh thu (đã thanh toán)</div>
          <div style="font-size:20px; font-weight:700;">
            <span id="statTotalRevenue">0</span> ₫
          </div>
          <div class="small-muted">Số hoá đơn: <strong id="statInvoiceCount">0</strong></div>
        </div>

        <div style="background:#fff; border:1px solid #e6e9ef; border-radius:10px; padding:10px; box-shadow:0 8px 20px rgba(12,24,40,0.04);">
          <div class="muted">Tổng lãi</div>
          <div style="font-size:20px; font-weight:700;">
            <span id="statTotalProfit">0</span> ₫
          </div>
          <div class="small-muted">
            Biên lãi: <strong id="statProfitMargin">0%</strong>
          </div>
        </div>

        <div style="background:#fff; border:1px solid #e6e9ef; border-radius:10px; padding:10px; box-shadow:0 8px 20px rgba(12,24,40,0.04);">
          <div class="muted">Tổng vốn (ước tính)</div>
          <div style="font-size:20px; font-weight:700;">
            <span id="statTotalCost">0</span> ₫
          </div>
          <div class="small-muted">Tổng món bán ra: <strong id="statTotalItemsQty">0</strong></div>
        </div>
      </div>

      <!-- Notes / warnings -->
      <div id="statHint" class="muted" style="margin-top:10px;">
        * Chỉ tính từ các hoá đơn trạng thái “Đã thanh toán”. Lãi/vốn sẽ đúng khi bạn có dữ liệu giá vốn theo món.
      </div>

      <!-- Per-item table -->
      <div style="margin-top:12px; overflow:auto; border:1px solid #e6e9ef; border-radius:10px; background:#fff;">
        <table style="width:100%; border-collapse:collapse; min-width:820px;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid #eef1f6;">
              <th style="padding:10px;">Món</th>
              <th style="padding:10px; width:90px;">SL</th>
              <th style="padding:10px; width:160px;">Doanh thu</th>
              <th style="padding:10px; width:160px;">Vốn</th>
              <th style="padding:10px; width:160px;">Lãi</th>
              <th style="padding:10px; width:110px;">Biên lãi</th>
            </tr>
          </thead>
          <tbody id="statItemTbody">
            <!-- JS render rows -->
          </tbody>
        </table>
      </div>

      <!-- Empty / loading -->
      <div id="statLoading" class="muted hidden" style="margin-top:10px;">
        Đang tính toán…
      </div>
      <div id="statEmpty" class="muted hidden" style="margin-top:10px;">
        Không có dữ liệu phù hợp.
      </div>
      <div id="statError" class="error hidden" style="margin-top:10px;"></div>

      <!-- Actions -->
      <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" id="statExportBtn" type="button">Xuất CSV</button>
        <button class="btn" id="statCopyBtn" type="button">Copy báo cáo</button>
        <button class="btn" id="statCloseBtn" type="button">Đóng</button>
      </div>

    </div>
  </div>

  <!-- ===== JS ===== -->
  <script type="module" src="./assets/js/app.js?v=63"></script>

</body>
</html>
