<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách sản phẩm</title>
  <style>
    :root{--gap:12px;--pad:14px;--muted:#666}
    body { font-family: Arial, sans-serif; padding: 18px; margin:0; background:#fafafa }
    h1{margin:0 0 12px}

    .list { display:flex; flex-direction:column; gap:12px }
    .item { background:#fff; border-radius:8px; padding:12px; box-shadow:0 0 0 1px #eee }
    .item .name { font-weight:700; margin-bottom:8px }

    .price-line{display:flex; gap:12px; align-items:center}
    .price-block{flex:1; display:flex; flex-direction:column}
    .label-inline{font-size:12px; color:var(--muted)}
    .value{font-weight:700}

    .qty-row{display:flex; gap:12px; align-items:center; margin-top:10px}
    .qty-row label{display:flex; gap:8px; align-items:center}
    .qty{width:64px; padding:6px}

    .controls{display:flex; gap:12px; align-items:center; margin-top:14px}
    .control { display:flex; flex-direction:column; gap:6px }
    .small { font-size: 13px; color: var(--muted); }

    .total { font-weight: bold; margin-top: 18px; font-size: 18px }

    /* Mobile tweaks */
    @media (max-width:720px){
      .price-line{gap:8px}
      .price-block{flex-basis:0}
      .qty{width:56px}
      .controls{flex-direction:row}
      .control{flex:1}
      .mobile-total-bar{position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #ddd; padding:10px 12px; display:flex; justify-content:space-between; align-items:center}
      .page-bottom-padding{height:64px}
    }
  </style>
</head>
<body>
  <h1>Danh sách sản phẩm</h1>

  <div class="list" id="product-list">
    <div class="item" data-id="donut">
      <div class="name">Bánh rán</div>
      <div class="price-line">
        <div class="price-block">
          <div class="label-inline">Giá bán</div>
          <div class="value price" data-raw="10000">10k</div>
        </div>
        <div class="price-block">
          <div class="label-inline">Thành tiền</div>
          <div class="value subtotal">0</div>
        </div>
      </div>
      <div class="qty-row">
        <label>Số lượng <input type="number" min="0" class="qty" /></label>
      </div>
    </div>

    <div class="item" data-id="nem">
      <div class="name">Nem chua rán</div>
      <div class="price-line">
        <div class="price-block">
          <div class="label-inline">Giá bán</div>
          <div class="value price" data-raw="15000">15k</div>
        </div>
        <div class="price-block">
          <div class="label-inline">Thành tiền</div>
          <div class="value subtotal">0</div>
        </div>
      </div>
      <div class="qty-row">
        <label>Số lượng <input type="number" min="0" class="qty" /></label>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="control">
      <label>Phí ship
        <input type="text" id="ship_fee" data-raw="0" value="0" />
      </label>
    </div>
    <div class="control">
      <label>Chiết khấu
        <input type="text" id="discount" data-raw="0" value="0" />
      </label>
    </div>
  </div>

  <div class="total">Tổng tiền: <span id="total">0</span></div>

  <div class="page-bottom-padding" aria-hidden="true"></div>
  <div class="mobile-total-bar" id="mobileBar" style="display:none">
    <div>
      <div class="small">Tổng</div>
      <div id="mobile_total" style="font-weight:700">0</div>
    </div>
  </div>

  <script>
    function formatK(num) {
      if (!isFinite(num)) return '0';
      const k = num / 1000;
      if (Number.isInteger(k)) return k + 'k';
      return (Math.round(k * 10) / 10) + 'k';
    }
    function formatVND(num) {
      if (!isFinite(num)) return '0';
      return new Intl.NumberFormat('vi-VN').format(num);
    }
    function parseRaw(val) {
      if (val == null) return 0;
      if (typeof val === 'string') {
        const cleaned = val.replace(/[^0-9\-]/g,'');
        return parseInt(cleaned) || 0;
      }
      return Number(val) || 0;
    }

    function init() {
      document.querySelectorAll('.price').forEach(el=>{
        const raw = parseRaw(el.dataset.raw);
        el.textContent = formatK(raw);
      });
      document.querySelectorAll('.cost_price').forEach(el=>{
        const raw = parseRaw(el.dataset.raw);
        el.textContent = formatK(raw);
      });

      ['ship_fee','discount'].forEach(id=>{
        const el = document.getElementById(id);
        const n = parseRaw(el.value || el.dataset.raw);
        el.dataset.raw = n; el.value = formatVND(n);
      });

      if (window.matchMedia && window.matchMedia('(max-width:720px)').matches) document.getElementById('mobileBar').style.display='flex';

      // attach events
      document.querySelectorAll('.qty').forEach(q=>{
        q.addEventListener('input', calculate);
      });
      setupFormattedInput('ship_fee'); setupFormattedInput('discount');
      calculate();
    }

    function calculate(){
      let total = 0;
      document.querySelectorAll('.item').forEach(item=>{
        const price = parseRaw(item.querySelector('.price').dataset.raw);
        const qty = parseInt(item.querySelector('.qty').value)||0;
        const subtotal = price*qty;
        item.querySelector('.subtotal').textContent = formatK(subtotal);
        total += subtotal;
      });
      const ship = parseRaw(document.getElementById('ship_fee').dataset.raw||document.getElementById('ship_fee').value);
      const discount = parseRaw(document.getElementById('discount').dataset.raw||document.getElementById('discount').value);
      const finalTotal = total + ship - discount;
      document.getElementById('total').textContent = formatK(finalTotal);
      document.getElementById('mobile_total').textContent = formatK(finalTotal);
    }

    function setupFormattedInput(id){
      const el=document.getElementById(id);
      el.addEventListener('input',(e)=>{
        const digits=(e.target.value||'').replace(/[^0-9]/g,'');
        const n=parseInt(digits)||0; e.target.dataset.raw=n; e.target.value=formatVND(n); calculate();
      });
      el.addEventListener('focus',(e)=>{ e.target.value=String(e.target.dataset.raw||'0'); setTimeout(()=>{try{e.target.setSelectionRange(e.target.value.length,e.target.value.length)}catch(err){}},0); });
      el.addEventListener('blur',(e)=>{ const n=parseRaw(e.target.value)||parseRaw(e.target.dataset.raw); e.target.dataset.raw=n; e.target.value=formatVND(n); calculate(); });
    }
    init();
  </script>
</body>
</html>
