<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách sản phẩm — Bản gọn đẹp</title>
  <style>
    :root{
      --gap:12px;
      --pad:12px;
      --muted:#666;
      --card-bg:#fff;
      --card-border:#e6e9ef;
      --accent:#0b84ff;
      --radius:10px;
      --shadow: 0 6px 18px rgba(12,24,40,0.06);
      --fav-color: #ffb400;
    }
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:18px; margin:0; background:#f6f8fb; color:#111 }
    h1{margin:0 0 14px; font-size:20px}

    /* Controls top: only favorite toggle (req) */
    .top-controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .top-controls .btn{padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}

    /* Grid list - default 2 columns (req #4) */
    .list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--gap);
      margin-bottom: 12px;
      align-items: start;
    }

    /* When filtering favorites: single column full width */
    .list.single-column {
      grid-template-columns: repeat(1, 1fr);
    }

    /* Card */
    .item {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding:10px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height:88px;
      position:relative;
    }

    .thumb {
      width:64px; height:64px; flex:0 0 64px;
      border-radius:8px; background:linear-gradient(135deg,#f0f4ff,#fff);
      display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px;
      border:1px dashed #eef;
    }

    .meta {
      flex:1; display:flex; flex-direction:column; gap:6px;
    }
    .name { font-weight:700; font-size:14px; line-height:1.1; }
    .price-line{display:flex; gap:8px; align-items:center; font-size:13px}
    .label-inline{font-size:12px; color:var(--muted)}
    .value{font-weight:700}

    /* price badge at top-right of card */
    .price-badge {
      position:absolute; right:10px; top:10px;
      background:#fff; border:1px solid var(--card-border); padding:6px 8px; border-radius:8px; font-weight:700;
      box-shadow: 0 6px 16px rgba(12,24,40,0.04);
    }

    /* size toggle */
    .size-toggle {
      display:inline-flex; gap:6px; align-items:center;
    }
    .size-label { padding:6px 8px; border-radius:8px; border:1px solid #eee; background:#fafafa; font-size:13px }
    .size-btn {
      padding:6px 8px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px;
    }
    .size-btn.active { background:var(--accent); color:#fff; border-color:var(--accent) }

    /* qty controls */
    .qty-row{display:flex; gap:6px; align-items:center; margin-top:6px}
    .qty-input{width:58px; padding:6px; border-radius:6px; border:1px solid #ddd; text-align:center}
    .btn-qty{padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer}

    /* favorite button moved to bottom-right and styled like a button (req #1) */
    .fav-btn {
      position:absolute; right:10px; bottom:10px;
      background:#fff; border:1px solid var(--card-border); border-radius:8px; padding:6px 8px;
      cursor:pointer; font-size:16px; line-height:1; display:inline-flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 16px rgba(12,24,40,0.04);
    }
    .fav-btn[aria-pressed="true"]{
      color: #fff; background:var(--fav-color); border-color: rgba(0,0,0,0.06);
      transform: translateY(-1px);
    }
    .fav-btn:hover { transform: translateY(-1px); }

    /* Controls bottom: ship, discount, invoice (req: these at bottom) */
    .bottom-controls { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .bottom-controls .control { display:flex; gap:8px; align-items:center }
    .bottom-controls input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd; min-width:120px}

    .actions{display:flex; gap:8px; margin-top:6px}
    .btn{padding:10px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.toggle.active{background:#f0f8ff; border-color:var(--accent); color:var(--accent)}

    .summary {
      margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:12px; background:#fff; border-radius:10px; border:1px solid var(--card-border);
      box-shadow:var(--shadow);
    }
    .summary .total { font-weight:800; font-size:16px }

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px}
    .modal{width:100%; max-width:520px; background:#fff; border-radius:12px; padding:16px; box-shadow:0 18px 40px rgba(0,0,0,0.25)}
    .modal h2{margin:0 0 8px; font-size:18px}
    .compact { font-size:16px }
    .compact .line{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #f0f4f0}
    .compact .meta{color:var(--muted); font-size:13px}
    .modal .footer{display:flex; justify-content:space-between; align-items:center; margin-top:12px}

    /* Responsive tweaks */
    @media (max-width:820px){
      .list{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width:480px){
      .list:not(.single-column){ grid-template-columns: repeat(2, 1fr); }
      .list.single-column{ grid-template-columns: repeat(1, 1fr); }
      .thumb{width:56px;height:56px}
    }

    .muted{color:var(--muted); font-size:13px}
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <h1>Danh sách sản phẩm</h1>

  <div class="top-controls">
    <button class="btn toggle" id="showFavsBtn" aria-pressed="false" title="Chỉ hiện mục yêu thích">Yêu thích</button>
  </div>

  <div class="list" id="product-list" aria-live="polite"></div>

  <!-- bottom controls -->
  <div class="bottom-controls" id="bottomControls">
    <div class="control">
      <label class="muted">Phí ship
        <input type="text" id="ship_fee" data-raw="0" value="0" />
      </label>
    </div>
    <div class="control">
      <label class="muted">Giảm giá
        <input type="text" id="discount" data-raw="0" value="0" />
      </label>
    </div>

    <div style="margin-left:auto" class="actions">
      <button class="btn" id="collapseBtn">Hoá đơn</button>
    </div>
  </div>

  <div class="summary" aria-live="polite">
    <div class="muted">Món đã chọn: <span id="selectedCount">0</span> · Yêu thích: <span id="favCount">0</span></div>
    <div class="total">Tổng: <span id="grandTotal">0</span> ₫</div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" id="modal">
      <h2>Hoá đơn</h2>
      <div id="compactList" class="compact" aria-live="polite"></div>

      <div class="footer">
        <div class="meta">Ship: <span id="modal_ship">0</span> · Giảm giá: <span id="modal_discount">0</span></div>
        <div style="font-weight:800">Tổng: <span id="modal_total">0</span></div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn" id="closeModal">Đóng</button>
      </div>
    </div>
  </div>

  <script>
    /* --- DATA: normalize to {name, variants:[{label,price}]} --- */
    const RAW = [
      ["Nem TCC (sống)",3800],
      ["Nem TCC xù (sống)",4000],
      ["Nem TCC vỏ giòn (sống)",5000],
      ["Nem TCC phomai (sống)",11000],
      ["Nem TCC xù",6500],
      ["Nem TCC vỏ giòn",7000],
      ["Nem TCC phomai",13000],
      ["Bánh rán mặn",8000],
      ["Bánh rán phomai",8000],
      ["Nem chua thường",7000],
      ["Nem chua phomai",9000],
      ["Nem chua vỏ giòn",5000],
      // Bánh xèo with two sizes (req #5)
      ["Bánh xèo nhật chay", {small:40000, large:60000}],
      ["Gà chiên mắm",35000],
      ["Chân gà rút xương",7000],
      ["Thịt chưng mắm tép",35000],
      ["Salad",40000],
      ["Bún thang chay",45000],
      ["Xôi nấm",45000],
      ["Cốt chay",35000],
      ["Mọc chay",11000],
      ["Giò nấm chay",11000],
      ["Chả cốm chay",12000],
      ["Ruốc nấm",35000],
      ["Xôi cốm",18000],
      ["Chạo chay",40000],
      ["Cốm xào",18000],
      ["Canh mọc chay",60000],
    ];

    const PRODUCTS = RAW.map(entry => {
      const [name, p] = entry;
      if (typeof p === 'number') {
        return { name, variants: [{ label: 'M', price: p }] };
      } else if (typeof p === 'object' && p !== null) {
        const variants = Object.keys(p).map(k => ({ key: k, label: k.charAt(0).toUpperCase() + k.slice(1), price: p[k] }));
        return { name, variants };
      } else {
        return { name, variants: [{ label: 'M', price: 0 }] };
      }
    });

    // Favorites stored in-memory; include Bánh rán mặn by default
    const FAV_INIT = ["Bánh rán mặn"];
    let favorites = new Set(FAV_INIT.slice());
    let filterFavsOnly = false;

    // utils
    function formatVND(num) {
      if (!isFinite(num)) return '0';
      return new Intl.NumberFormat('vi-VN').format(num);
    }
    function parseRaw(val) {
      if (val == null) return 0;
      if (typeof val === 'string') {
        const cleaned = val.replace(/[^0-9\-]/g,'');
        return parseInt(cleaned) || 0;
      }
      return Number(val) || 0;
    }

    const listRoot = document.getElementById('product-list');

    function createItemElement(prod){
      const { name, variants } = prod;
      const defaultVariant = variants[0];
      const item = document.createElement('div');
      item.className = 'item';
      item.dataset.price = String(defaultVariant.price);
      item.dataset.name = name;
      // if multiple variants, set toggle visible
      const hasMultiple = variants.length > 1;

      // prepare toggle: default to first variant (index 0)
      const toggleButton = hasMultiple ? `<div class="size-toggle"><span class="size-label" aria-hidden="true">${variants[0].label}</span><button class="size-btn" data-index="0">Small</button></div>` : '';

      const isFav = favorites.has(name) ? 'true' : 'false';

      item.innerHTML = `
        <div class="thumb">Ảnh</div>

        <div class="meta">
          <div class="name">${escapeHtml(name)}</div>

          <div class="price-line">
            <div class="label-inline">Giá</div>&nbsp;<div class="value price">${formatVND(defaultVariant.price)}</div>
          </div>

          <div style="display:flex; gap:8px; margin-top:6px; align-items:center">
            ${ !hasMultiple ? `<div class="size-label" aria-hidden="true">${defaultVariant.label}</div>` :
              `<div class="size-toggle" role="group" aria-label="Chọn cỡ cho ${escapeHtml(name)}">
                 <div class="size-label" style="margin-right:8px">${variants[0].label}</div>
                 <button type="button" class="size-btn" data-index="0" aria-pressed="true">${variants[0].label}</button>
                 <button type="button" class="size-btn" data-index="1" aria-pressed="false">${variants[1].label}</button>
               </div>`
            }
          </div>

          <div class="qty-row">
            <button class="btn-qty dec" aria-label="Giảm">−</button>
            <input type="number" min="0" class="qty-input" value="0" aria-label="Số lượng ${escapeHtml(name)}" />
            <button class="btn-qty inc" aria-label="Tăng">+</button>
          </div>
        </div>

        <div class="price-badge">${formatVND(defaultVariant.price)} ₫</div>

        <button class="fav-btn" aria-pressed="${isFav}" title="Thêm vào yêu thích">★</button>
      `;
      return item;
    }

    function renderList(){
      listRoot.innerHTML = '';
      PRODUCTS.forEach(prod => {
        const el = createItemElement(prod);
        listRoot.appendChild(el);
      });

      // attach events
      document.querySelectorAll('.item').forEach(it=>{
        const inc = it.querySelector('.inc');
        const dec = it.querySelector('.dec');
        const q = it.querySelector('.qty-input');
        const favBtn = it.querySelector('.fav-btn');
        const name = it.dataset.name;
        const priceNode = it.querySelector('.price');
        const priceBadge = it.querySelector('.price-badge');
        const sizeBtns = it.querySelectorAll('.size-btn');

        // qty
        inc.addEventListener('click', ()=>{ q.value = Math.max(0, parseInt(q.value||0)+1); onQtyChange(it); });
        dec.addEventListener('click', ()=>{ q.value = Math.max(0, parseInt(q.value||0)-1); onQtyChange(it); });
        q.addEventListener('input', ()=>{ q.value = Math.max(0, parseInt(q.value||0) || 0); onQtyChange(it); });

        // favorite toggle
        favBtn.addEventListener('click', ()=>{
          const pressed = favBtn.getAttribute('aria-pressed') === 'true';
          if(pressed){
            favorites.delete(name);
            favBtn.setAttribute('aria-pressed','false');
          } else {
            favorites.add(name);
            favBtn.setAttribute('aria-pressed','true');
          }
          updateFavCount();
          applyFilter();
        });

        // size toggle buttons (if exist) — implement as two-button toggle, default index 0 (Small)
        if(sizeBtns && sizeBtns.length){
          sizeBtns.forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const idx = Number(btn.dataset.index) || 0;
              // find product variants
              const prod = PRODUCTS.find(p => p.name === name);
              if(!prod) return;
              const variant = prod.variants[idx] || prod.variants[0];
              // update aria-pressed states
              sizeBtns.forEach(b=> b.setAttribute('aria-pressed', b === btn ? 'true' : 'false'));
              // update displayed label(s)
              const lbl = it.querySelector('.size-label');
              if(lbl) lbl.textContent = variant.label;
              // update dataset price and UI
              it.dataset.price = String(variant.price);
              if(priceNode) priceNode.textContent = formatVND(variant.price);
              if(priceBadge) priceBadge.textContent = formatVND(variant.price) + ' ₫';
              // recalc subtotal if quantity > 0
              onQtyChange(it);
            });
          });
        }
      });

      calculateAll();
      updateFavCount();
      applyFilter();
    }

    // init
    function init(){
      renderList();

      document.getElementById('collapseBtn').addEventListener('click', openCompactPopup);
      document.getElementById('closeModal').addEventListener('click', closeModal);

      // favorites UI (top)
      const showFavsBtn = document.getElementById('showFavsBtn');
      showFavsBtn.addEventListener('click', ()=>{
        filterFavsOnly = !filterFavsOnly;
        showFavsBtn.classList.toggle('active', filterFavsOnly);
        showFavsBtn.setAttribute('aria-pressed', String(filterFavsOnly));
        applyFilter();
      });

      // format ship/discount inputs
      ['ship_fee','discount'].forEach(id=>{
        const el=document.getElementById(id);
        const n=parseRaw(el.value||el.dataset.raw);
        el.dataset.raw=n;
        el.value=formatVND(n);
        setupFormattedInput(id);
      });
    }

    function onQtyChange(item){
      // quantity affects totals but per-item "thành tiền" removed as requested;
      // keep calculation using dataset.price * qty, and grand total displays final.
      const price = parseRaw(item.dataset.price);
      const qty = parseInt(item.querySelector('.qty-input').value)||0;
      // no per-item subtotal UI (removed). Recompute totals.
      calculateAll();
    }

    function calculateAll(){
      let total = 0;
      let selectedCount = 0;
      document.querySelectorAll('.item').forEach(item=>{
        if(filterFavsOnly && !favorites.has(item.dataset.name)) return;
        const price = parseRaw(item.dataset.price);
        const qty = parseInt(item.querySelector('.qty-input').value)||0;
        const subtotal = price * qty;
        if(qty>0) selectedCount++;
        total += subtotal;
      });

      const ship = parseRaw(document.getElementById('ship_fee').dataset.raw || document.getElementById('ship_fee').value);
      const discount = parseRaw(document.getElementById('discount').dataset.raw || document.getElementById('discount').value);

      const grand = total + ship - discount;
      document.getElementById('selectedCount').textContent = String(selectedCount);
      document.getElementById('grandTotal').textContent = formatVND(Math.max(0, grand));
    }

    function setupFormattedInput(id){
      const el=document.getElementById(id);
      el.addEventListener('input',e=>{
        const digits=(e.target.value||'').replace(/[^0-9]/g,'');
        const n=parseInt(digits)||0;
        e.target.dataset.raw=n;
        e.target.value=formatVND(n);
        calculateAll();
      });
      el.addEventListener('focus',e=>{
        e.target.value=String(e.target.dataset.raw||'0');
        setTimeout(()=>{try{e.target.setSelectionRange(e.target.value.length,e.target.value.length)}catch(err){}},0)
      });
      el.addEventListener('blur',e=>{
        const n=parseRaw(e.target.value)||parseRaw(e.target.dataset.raw); e.target.dataset.raw=n; e.target.value=formatVND(n); calculateAll();
      });
    }

    // apply favorites-only filter and toggle single-column layout as requested
    function applyFilter(){
      const anyFavs = favorites.size > 0;
      document.querySelectorAll('.item').forEach(item=>{
        const isFav = favorites.has(item.dataset.name);
        if(filterFavsOnly){
          if(!isFav) item.classList.add('hidden'); else item.classList.remove('hidden');
        } else {
          item.classList.remove('hidden');
        }
      });

      if(filterFavsOnly && anyFavs){
        listRoot.classList.add('single-column');
      } else {
        listRoot.classList.remove('single-column');
      }

      calculateAll();
      updateFavCount();
    }

    function updateFavCount(){
      document.getElementById('favCount').textContent = String(favorites.size);
    }

    function openCompactPopup(){
      const listEl=document.getElementById('compactList'); listEl.innerHTML='';
      let total=0; let count=0;
      document.querySelectorAll('.item').forEach(item=>{
        if(item.classList.contains('hidden')) return;
        const name=item.querySelector('.name').textContent.trim();
        const price=parseRaw(item.dataset.price);
        const qty=parseInt(item.querySelector('.qty-input').value)||0;
        if(qty>0){
          count++;
          const subtotal=price*qty; total+=subtotal;
          const row=document.createElement('div'); row.className='line';
          row.innerHTML=`<div style="flex:1">${count}. ${escapeHtml(name)}  x${qty}</div><div style="min-width:90px; text-align:right">${formatVND(subtotal)} ₫</div>`;
          listEl.appendChild(row);
        }
      });

      const ship=parseRaw(document.getElementById('ship_fee').dataset.raw||document.getElementById('ship_fee').value);
      const discount=parseRaw(document.getElementById('discount').dataset.raw||document.getElementById('discount').value);
      document.getElementById('modal_ship').textContent = formatVND(ship) + ' ₫';
      document.getElementById('modal_discount').textContent = formatVND(discount) + ' ₫';
      document.getElementById('modal_total').textContent = formatVND(Math.max(0, total + ship - discount)) + ' ₫';

      if(count===0){ listEl.innerHTML='<div class="muted">Chưa có món nào được chọn.</div>'; }

      const backdrop=document.getElementById('modalBackdrop'); backdrop.style.display='flex';
      document.getElementById('closeModal').focus();
    }

    function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; }
    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    init();
  </script>
</body>
</html>
