<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách sản phẩm — Bản gọn đẹp</title>
  <style>
    :root{
      --gap:12px;
      --pad:12px;
      --muted:#666;
      --card-bg:#fff;
      --card-border:#eee;
      --accent:#0b84ff;
      --radius:10px;
      --shadow: 0 6px 18px rgba(12,24,40,0.06);
    }
    /* Reset-ish */
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:18px; margin:0; background:#f6f8fb; color:#111 }
    h1{margin:0 0 14px; font-size:20px}

    /* Grid list */
    .list {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
      margin-bottom: 12px;
    }

    /* Card */
    .item {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding:10px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height:88px;
    }

    .thumb {
      width:64px; height:64px; flex:0 0 64px;
      border-radius:8px; background:linear-gradient(135deg,#f0f4ff,#fff);
      display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px;
      border:1px dashed #eef;
    }

    .meta {
      flex:1; display:flex; flex-direction:column; gap:6px;
    }
    .name { font-weight:700; font-size:14px; line-height:1.1; }
    .price-line{display:flex; gap:8px; align-items:center; font-size:13px}
    .label-inline{font-size:12px; color:var(--muted)}
    .value{font-weight:700}

    /* qty controls */
    .qty-row{display:flex; gap:6px; align-items:center; margin-top:6px}
    .qty-input{width:58px; padding:6px; border-radius:6px; border:1px solid #ddd; text-align:center}
    .btn-qty{padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer}

    /* subtotal right */
    .right {
      display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:110px;
    }
    .subtotal { font-weight:700; font-size:14px }

    /* Controls below */
    .controls { display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap }
    .control { display:flex; gap:8px; align-items:center }
    .controls input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd; min-width:120px}

    .actions{display:flex; gap:8px; margin-top:6px}
    .btn{padding:10px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}

    .summary {
      margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:12px; background:#fff; border-radius:10px; border:1px solid var(--card-border);
      box-shadow:var(--shadow);
    }
    .summary .total { font-weight:800; font-size:16px }

    /* Modal for compact summary (screenshot friendly) */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px}
    .modal{width:100%; max-width:520px; background:#fff; border-radius:12px; padding:16px; box-shadow:0 18px 40px rgba(0,0,0,0.25)}
    .modal h2{margin:0 0 8px; font-size:18px}
    .compact { font-size:16px }
    .compact .line{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #f0f0f0}
    .compact .meta{color:var(--muted); font-size:13px}
    .modal .footer{display:flex; justify-content:space-between; align-items:center; margin-top:12px}

    /* Responsive */
    @media (max-width:1100px){
      .list{grid-template-columns: repeat(3, 1fr);}
    }
    @media (max-width:820px){
      .list{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width:480px){
      .list{grid-template-columns: repeat(2, 1fr);}
      .thumb{width:56px;height:56px}
      .right{min-width:96px}
    }

    /* small utility */
    .muted{color:var(--muted); font-size:13px}
  </style>
</head>
<body>
  <h1>Danh sách sản phẩm</h1>

  <div class="list" id="product-list">
    <!-- Items: keep original dataset but rendered compact -->
    <!-- I'll keep your original items but with markup ready for grid -->
  </div>

  <div class="controls">
    <div class="control">
      <label class="muted">Phí ship
        <input type="text" id="ship_fee" data-raw="0" value="0" />
      </label>
    </div>
    <div class="control">
      <label class="muted">Giảm giá
        <input type="text" id="discount" data-raw="0" value="0" />
      </label>
    </div>

    <div style="margin-left:auto" class="actions">
      <button class="btn" id="collapseBtn">Hoá đơn</button>
    </div>
  </div>

  <div class="summary" aria-live="polite">
    <div class="muted">Món đã chọn: <span id="selectedCount">0</span></div>
    <div class="total">Tổng: <span id="grandTotal">0</span> ₫</div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" id="modal">
      <h2>Hoá đơn</h2>
      <div id="compactList" class="compact" aria-live="polite"></div>

      <div class="footer">
        <div class="meta">Ship: <span id="modal_ship">0</span> · Giảm giá: <span id="modal_discount">0</span></div>
        <div style="font-weight:800">Tổng: <span id="modal_total">0</span></div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn" id="closeModal">Đóng</button>
      </div>
    </div>
  </div>

  <script>
    // Data: reuse your original list with price (vnd) and name
    const PRODUCTS = [
      ["Nem TCC (sống)",3800],
      ["Nem TCC xù (sống)",4000],
      ["Nem TCC vỏ giòn (sống)",5000],
      ["Nem TCC phomai (sống)",11000],
      ["Nem TCC xù",6500],
      ["Nem TCC vỏ giòn",7000],
      ["Nem TCC phomai",13000],
      ["Bánh rán mặn",8000],
      ["Bánh rán phomai",8000],
      ["Nem chua thường",7000],
      ["Nem chua phomai",9000],
      ["Nem chua vỏ giòn",5000],
      ["Bánh xèo nhật chay",60000],
      ["Gà chiên mắm",35000],
      ["Chân gà rút xương",7000],
      ["Thịt chưng mắm tép",35000],
      ["Salad",40000],
      ["Bún thang chay",45000],
      ["Xôi nấm",45000],
      ["Cốt chay",35000],
      ["Mọc chay",11000],
      ["Giò nấm chay",11000],
      ["Chả cốm chay",12000],
      ["Ruốc nấm",35000],
      ["Xôi cốm",18000],
      ["Chạo chay",40000],
      ["Cốm xào",18000],
      ["Canh mọc chay",60000],
    ];

    // Utilities
    function formatVND(num) {
      if (!isFinite(num)) return '0';
      return new Intl.NumberFormat('vi-VN').format(num);
    }
    function parseRaw(val) {
      if (val == null) return 0;
      if (typeof val === 'string') {
        const cleaned = val.replace(/[^0-9\-]/g,'');
        return parseInt(cleaned) || 0;
      }
      return Number(val) || 0;
    }

    // Build list programmatically so it's easy to maintain
    const listRoot = document.getElementById('product-list');
    PRODUCTS.forEach((p, idx) => {
      const [name, price] = p;
      const item = document.createElement('div');
      item.className = 'item';
      item.dataset.price = String(price);

      item.innerHTML = `
        <div class="thumb">Ảnh</div>
        <div class="meta">
          <div class="name">${escapeHtml(name)}</div>
          <div class="price-line"><div class="label-inline">Giá</div>&nbsp;<div class="value price">${formatVND(price)}</div></div>
          <div class="qty-row">
            <button class="btn-qty dec" aria-label="Giảm">−</button>
            <input type="number" min="0" class="qty-input" value="0" aria-label="Số lượng ${escapeHtml(name)}" />
            <button class="btn-qty inc" aria-label="Tăng">+</button>
            <div class="muted" style="margin-left:auto">Thành tiền: <span class="subtotal">0</span></div>
          </div>
        </div>
        <div class="right" aria-hidden="true">
          <div class="muted">Đơn vị</div>
          <div class="subtotal" style="font-size:13px">0</div>
        </div>
      `;
      listRoot.appendChild(item);
    });

    // Init formatting and events
    function init(){
      // format ship/discount
      ['ship_fee','discount'].forEach(id=>{
        const el=document.getElementById(id);
        const n=parseRaw(el.value||el.dataset.raw);
        el.dataset.raw=n;
        el.value=formatVND(n);
        setupFormattedInput(id);
      });

      // qty events
      document.querySelectorAll('.item').forEach(it=>{
        const inc = it.querySelector('.inc');
        const dec = it.querySelector('.dec');
        const q = it.querySelector('.qty-input');
        inc.addEventListener('click', ()=>{ q.value = Math.max(0, parseInt(q.value||0)+1); onQtyChange(it); });
        dec.addEventListener('click', ()=>{ q.value = Math.max(0, parseInt(q.value||0)-1); onQtyChange(it); });
        q.addEventListener('input', ()=>{ q.value = Math.max(0, parseInt(q.value||0) || 0); onQtyChange(it); });
      });

      document.getElementById('collapseBtn').addEventListener('click', openCompactPopup);
      document.getElementById('closeModal').addEventListener('click', closeModal);

      calculateAll();
    }

    function onQtyChange(item){
      const price = parseRaw(item.dataset.price);
      const qty = parseInt(item.querySelector('.qty-input').value)||0;
      const subtotal = price * qty;
      // update both subtotals in item
      item.querySelectorAll('.subtotal').forEach(s=> s.textContent = qty>0 ? formatVND(subtotal) : '0');
      calculateAll();
    }

    function calculateAll(){
      let total = 0;
      let selectedCount = 0;
      document.querySelectorAll('.item').forEach(item=>{
        const price = parseRaw(item.dataset.price);
        const qty = parseInt(item.querySelector('.qty-input').value)||0;
        const subtotal = price * qty;
        if(qty>0) selectedCount++;
        total += subtotal;
      });

      const ship = parseRaw(document.getElementById('ship_fee').dataset.raw || document.getElementById('ship_fee').value);
      const discount = parseRaw(document.getElementById('discount').dataset.raw || document.getElementById('discount').value);

      const grand = total + ship - discount;
      document.getElementById('selectedCount').textContent = String(selectedCount);
      document.getElementById('grandTotal').textContent = formatVND(Math.max(0, grand));
    }

    function setupFormattedInput(id){
      const el=document.getElementById(id);
      el.addEventListener('input',e=>{
        const digits=(e.target.value||'').replace(/[^0-9]/g,'');
        const n=parseInt(digits)||0;
        e.target.dataset.raw=n;
        e.target.value=formatVND(n);
        calculateAll();
      });
      el.addEventListener('focus',e=>{
        e.target.value=String(e.target.dataset.raw||'0');
        setTimeout(()=>{try{e.target.setSelectionRange(e.target.value.length,e.target.value.length)}catch(err){}},0)
      });
      el.addEventListener('blur',e=>{
        const n=parseRaw(e.target.value)||parseRaw(e.target.dataset.raw); e.target.dataset.raw=n; e.target.value=formatVND(n); calculateAll();
      });
    }

    // Build compact popup content: only items with qty>0, minimal layout for screenshot
    function openCompactPopup(){
      const listEl=document.getElementById('compactList'); listEl.innerHTML='';
      let total=0; let count=0;
      document.querySelectorAll('.item').forEach(item=>{
        const name=item.querySelector('.name').textContent.trim();
        const price=parseRaw(item.dataset.price);
        const qty=parseInt(item.querySelector('.qty-input').value)||0;
        if(qty>0){
          count++;
          const subtotal=price*qty; total+=subtotal;
          const row=document.createElement('div'); row.className='line';
          row.innerHTML=`<div style="flex:1">${count}. ${escapeHtml(name)}  x${qty}</div><div style="min-width:90px; text-align:right">${formatVND(subtotal)} ₫</div>`;
          listEl.appendChild(row);
        }
      });

      const ship=parseRaw(document.getElementById('ship_fee').dataset.raw||document.getElementById('ship_fee').value);
      const discount=parseRaw(document.getElementById('discount').dataset.raw||document.getElementById('discount').value);
      document.getElementById('modal_ship').textContent = formatVND(ship) + ' ₫';
      document.getElementById('modal_discount').textContent = formatVND(discount) + ' ₫';
      document.getElementById('modal_total').textContent = formatVND(Math.max(0, total + ship - discount)) + ' ₫';

      if(count===0){ listEl.innerHTML='<div class="muted">Chưa có món nào được chọn.</div>'; }

      // show modal
      const backdrop=document.getElementById('modalBackdrop'); backdrop.style.display='flex';
      // focus for keyboard users
      document.getElementById('closeModal').focus();
    }

    function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; }

    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Kick off
    init();
  </script>
</body>
</html>
